name: Collaboration Simulation

on:
  push:
    branches: [main, 'epic/*', 'feature/*']
    paths:
      - 'src/features/social-resonance-filter/**'
      - 'src/features/dreamnode-updater/**'
      - '.github/workflows/collaboration.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/features/social-resonance-filter/**'
      - 'src/features/dreamnode-updater/**'
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  multi-peer-simulation:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 5

      - name: Install Radicle
        run: |
          curl -sSf https://radicle.xyz/install | sh
          echo "$HOME/.radicle/bin" >> $GITHUB_PATH
        timeout-minutes: 5

      - name: Create peer identities
        run: |
          echo "Creating isolated Radicle identities for Alice, Bob, and Charlie..."

          for peer in alice bob charlie; do
            mkdir -p /tmp/$peer
            RAD_HOME=/tmp/$peer/.radicle RAD_PASSPHRASE=${peer}-passphrase rad auth --alias "$peer"
            echo "$peer DID: $(RAD_HOME=/tmp/$peer/.radicle rad self --did)"
          done
        timeout-minutes: 3

      - name: Create shared DreamNode
        run: |
          echo "Alice creates the shared DreamNode..."

          mkdir -p /tmp/alice/shared-dream
          cd /tmp/alice/shared-dream

          git init -b main
          git config user.email "alice@test.local"
          git config user.name "Alice"

          # Create initial content
          echo "# Shared Dream" > README.md
          echo "A collaborative DreamNode for testing." >> README.md
          git add README.md
          git commit -m "Initial commit by Alice"

          # Initialize as Radicle repo
          RAD_HOME=/tmp/alice/.radicle RAD_PASSPHRASE=alice-passphrase \
            rad init --public --default-branch main --name "Shared-Dream" --description "Collaborative test node"

          RID=$(RAD_HOME=/tmp/alice/.radicle rad .)
          echo "RID=$RID" >> $GITHUB_ENV
          echo "Created Radicle repo: $RID"
        timeout-minutes: 3

      - name: Bob makes a contribution
        run: |
          echo "Bob clones and contributes..."

          # For local testing, we simulate by creating Bob's version directly
          # In real P2P, Bob would: rad clone $RID

          mkdir -p /tmp/bob/shared-dream
          cd /tmp/bob/shared-dream

          git init -b main
          git config user.email "bob@test.local"
          git config user.name "Bob"

          # Copy Alice's content
          cp /tmp/alice/shared-dream/README.md .
          git add README.md
          git commit -m "Initial commit by Alice"

          # Bob's contribution - in a separate file to avoid conflicts
          echo "# Bob's Contribution" > bob.md
          echo "Bob was here." >> bob.md
          git add bob.md
          git commit -m "Add Bob's contribution"

          echo "Bob's contribution committed"
        timeout-minutes: 2

      - name: Charlie makes a contribution
        run: |
          echo "Charlie clones and contributes..."

          mkdir -p /tmp/charlie/shared-dream
          cd /tmp/charlie/shared-dream

          git init -b main
          git config user.email "charlie@test.local"
          git config user.name "Charlie"

          # Copy Alice's content
          cp /tmp/alice/shared-dream/README.md .
          git add README.md
          git commit -m "Initial commit by Alice"

          # Charlie's contribution - in a separate file to avoid conflicts
          echo "# Charlie's Contribution" > charlie.md
          echo "Charlie was here too." >> charlie.md
          git add charlie.md
          git commit -m "Add Charlie's contribution"

          echo "Charlie's contribution committed"
        timeout-minutes: 2

      - name: Simulate cherry-pick workflow
        run: |
          echo "Alice receives and integrates contributions..."

          cd /tmp/alice/shared-dream

          # Add Bob and Charlie as remotes
          git remote add bob /tmp/bob/shared-dream
          git remote add charlie /tmp/charlie/shared-dream

          # Fetch their changes
          git fetch bob
          git fetch charlie

          # List pending commits
          echo "Pending from Bob:"
          git log HEAD..bob/main --oneline

          echo "Pending from Charlie:"
          git log HEAD..charlie/main --oneline

          # Cherry-pick Bob's commit (simulating accept)
          BOB_COMMIT=$(git log bob/main --format=%H -1)
          git cherry-pick -x $BOB_COMMIT

          # Cherry-pick Charlie's commit (simulating accept)
          CHARLIE_COMMIT=$(git log charlie/main --format=%H -1)
          git cherry-pick -x $CHARLIE_COMMIT

          echo "Final state:"
          git log --oneline
          cat README.md
        timeout-minutes: 3

      - name: Summary
        run: |
          echo "### Multi-Peer Collaboration Simulation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Peer | Action | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Alice | Create DreamNode | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Bob | Contribute | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Charlie | Contribute | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Alice | Cherry-pick Bob | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Alice | Cherry-pick Charlie | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This simulates the basic cherry-pick collaboration workflow without full Radicle P2P networking." >> $GITHUB_STEP_SUMMARY
