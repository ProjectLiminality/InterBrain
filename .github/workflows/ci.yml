name: CI

on:
  push:
    branches: [main, 'epic/*', 'feature/*']
  pull_request:
    branches: [main]

jobs:
  check-all:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        timeout-minutes: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
        timeout-minutes: 3

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 5

      - name: Run lint
        run: npm run lint
        timeout-minutes: 2

      - name: Run typecheck
        run: npm run typecheck
        timeout-minutes: 3

      - name: Run tests
        run: npm run test
        timeout-minutes: 5

  install-script-syntax:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Verify install.sh syntax
        run: bash -n install.sh

      - name: Verify install.ps1 syntax
        run: |
          # Use pwsh to check PowerShell syntax
          pwsh -Command "[System.Management.Automation.Language.Parser]::ParseFile('install.ps1', [ref]\$null, [ref]\$null)" > /dev/null
          echo "install.ps1 syntax OK"

      - name: Test --ci flag is recognized
        run: |
          # Test that --ci flag prevents the non-interactive exit
          # The script will fail on missing deps (brew/apt), but should NOT fail with "NON-INTERACTIVE MODE NOT SUPPORTED"
          output=$(timeout 5 bash install.sh --ci 2>&1 || true)

          if echo "$output" | grep -q "NON-INTERACTIVE MODE NOT SUPPORTED"; then
            echo "ERROR: --ci flag not working - script still requires interactive mode"
            exit 1
          fi

          if echo "$output" | grep -q "Running in CI mode"; then
            echo "SUCCESS: --ci flag recognized"
          else
            echo "WARNING: CI mode message not found, but non-interactive error also not present"
          fi

          echo "Output preview:"
          echo "$output" | head -20

  # Full install script tests - run on each platform
  install-test-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Cache installed state
        id: cache-install
        uses: actions/cache@v4
        with:
          path: |
            ~/.radicle
            /tmp/interbrain-ci-*
            ~/.ollama
          key: install-linux-${{ hashFiles('install.sh') }}-v1
          restore-keys: |
            install-linux-

      - name: Run full install script
        if: steps.cache-install.outputs.cache-hit != 'true'
        run: |
          # Run install in CI mode
          bash install.sh --ci 2>&1 | tee /tmp/install-output.log

          # Check for critical failures
          if grep -q "Installation complete" /tmp/install-output.log; then
            echo "SUCCESS: Install script completed"
          else
            echo "WARNING: Install may not have completed fully"
            cat /tmp/install-output.log
          fi

      - name: Verify installed tools
        run: |
          echo "=== Verifying installed tools ==="
          git --version || echo "Git: NOT FOUND"
          node --version || echo "Node: NOT FOUND"
          npm --version || echo "npm: NOT FOUND"
          gh --version || echo "GitHub CLI: NOT FOUND"

          # Check Radicle (add to PATH since install.sh puts it in ~/.radicle/bin)
          export PATH="$HOME/.radicle/bin:$PATH"
          if command -v rad &> /dev/null; then
            rad --version
          else
            echo "Radicle: NOT INSTALLED"
          fi

  install-test-macos:
    runs-on: macos-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - name: Cache installed state
        id: cache-install
        uses: actions/cache@v4
        with:
          path: |
            ~/.radicle
            /tmp/interbrain-ci-*
            ~/.ollama
          key: install-macos-${{ hashFiles('install.sh') }}-v1
          restore-keys: |
            install-macos-

      - name: Run full install script
        if: steps.cache-install.outputs.cache-hit != 'true'
        run: |
          # Run install in CI mode
          bash install.sh --ci 2>&1 | tee /tmp/install-output.log

          # Check for critical failures
          if grep -q "Installation complete" /tmp/install-output.log; then
            echo "SUCCESS: Install script completed"
          else
            echo "WARNING: Install may not have completed fully"
            cat /tmp/install-output.log
          fi

      - name: Verify installed tools
        run: |
          echo "=== Verifying installed tools ==="
          git --version || echo "Git: NOT FOUND"
          node --version || echo "Node: NOT FOUND"
          npm --version || echo "npm: NOT FOUND"
          gh --version || echo "GitHub CLI: NOT FOUND"

          # Check Radicle (add to PATH since install.sh puts it in ~/.radicle/bin)
          export PATH="$HOME/.radicle/bin:$PATH"
          if command -v rad &> /dev/null; then
            rad --version
          else
            echo "Radicle: NOT INSTALLED"
          fi

  install-test-windows:
    runs-on: windows-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - name: Cache installed state
        id: cache-install
        uses: actions/cache@v4
        with:
          path: |
            ~\.ollama
            ${{ runner.temp }}\interbrain-ci-*
          key: install-windows-${{ hashFiles('install.ps1') }}-v1
          restore-keys: |
            install-windows-

      - name: Run full install script
        if: steps.cache-install.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          # Run install in CI mode
          .\install.ps1 -CI 2>&1 | Tee-Object -FilePath "$env:TEMP\install-output.log"

          # Check for completion
          $output = Get-Content "$env:TEMP\install-output.log" -Raw
          if ($output -match "Installation complete") {
            Write-Host "SUCCESS: Install script completed"
          } else {
            Write-Host "WARNING: Install may not have completed fully"
            Get-Content "$env:TEMP\install-output.log"
          }

      - name: Verify installed tools
        shell: pwsh
        run: |
          # Don't fail on non-zero exit codes from external commands
          $ErrorActionPreference = "Continue"

          Write-Host "=== Verifying installed tools ==="
          try { git --version } catch { Write-Host "Git: NOT FOUND" }
          try { node --version } catch { Write-Host "Node: NOT FOUND" }
          try { npm --version } catch { Write-Host "npm: NOT FOUND" }
          try { gh --version | Select-Object -First 1 } catch { Write-Host "GitHub CLI: NOT FOUND" }

          # Check WSL status (not available on GitHub runners)
          Write-Host ""
          Write-Host "=== WSL Status ==="
          try {
            $wslList = wsl -l -v 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "WSL distributions:"
              Write-Host $wslList

              # Check if Radicle is installed in WSL
              Write-Host ""
              Write-Host "=== Radicle in WSL ==="
              $radVersion = wsl bash -c 'export PATH="$HOME/.radicle/bin:$PATH" && rad --version 2>/dev/null' 2>&1
              if ($LASTEXITCODE -eq 0) {
                Write-Host "Radicle version: $radVersion"
              } else {
                Write-Host "Radicle: Not installed in WSL (expected in CI mode)"
              }
            } else {
              Write-Host "WSL: Not available on this runner (expected)"
            }
          } catch {
            Write-Host "WSL: Not available on this runner (expected)"
          }

          # Check for rad wrapper
          Write-Host ""
          Write-Host "=== Rad Wrapper ==="
          $radWrapperPath = Join-Path $env:USERPROFILE ".interbrain\bin\rad.cmd"
          if (Test-Path $radWrapperPath) {
            Write-Host "Rad wrapper exists at: $radWrapperPath"
          } else {
            Write-Host "Rad wrapper: Not created (expected if WSL/Radicle not installed)"
          }

          # Ensure success exit code
          exit 0
